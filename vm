#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG="$SCRIPT_DIR/colima.yaml"
PROFILE="${L_COLIMA_PROFILE:-l}"
PROFILE_DIR="$HOME/.colima/$PROFILE"
PROFILE_CONFIG="$PROFILE_DIR/colima.yaml"

case "$1" in
  ssh)
    SSH_HOST="colima-$PROFILE"
    ssh "$SSH_HOST"
    ;;
  config)
    echo "=== CONFIG ==="
    mkdir -p "$PROFILE_DIR"
    if [[ -e "$PROFILE_CONFIG" ]]; then
      git --no-pager diff --no-index -b "$PROFILE_CONFIG" "$CONFIG" || true
      read -p "Config '$PROFILE_CONFIG' already exists. Overwrite? [y/N] " confirm
      if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 1
      fi
    fi
    cp "$CONFIG" "$PROFILE_CONFIG"
    echo "Config copied to $PROFILE_CONFIG"
    ;;
  setup)
    echo "=== SETUP VM ==="
    "$0" down
    "$0" config
    "$0" up
    "$0" provision
    ;;
  up)
    echo "=== STARTING VM ==="
    if [[ -x "$SCRIPT_DIR/hook_pre_up.sh" ]]; then
      echo "=== Running pre-up hook ==="
      "$SCRIPT_DIR/hook_pre_up.sh"
    fi
    colima start --profile "$PROFILE"
    ;;
  down)
    echo "=== STOPPING VM ==="
    colima stop --profile "$PROFILE"
    if [[ -x "$SCRIPT_DIR/hook_post_down.sh" ]]; then
      echo "=== Running post-down hook ==="
      "$SCRIPT_DIR/hook_post_down.sh"
    fi
    ;;
  health)
    echo "=== HEALTH CHECK ==="
    echo "=== VM Status (profile: $PROFILE) ==="
    colima status --profile "$PROFILE" 2>&1
    echo ""
    echo "=== VM IP ==="
    VM_IP=$(colima list --profile "$PROFILE" --json | grep -o '"address":"[^"]*"' | cut -d'"' -f4)
    if [[ -n "$VM_IP" ]]; then
      echo "IP: $VM_IP"
    else
      echo "IP: not assigned (enable network.address in colima.yaml)"
    fi
    echo ""
    echo "=== mDNS (Avahi) ==="
    if ping -c 1 -t 2 l.local &>/dev/null; then
      MDNS_IP=$(ping -c 1 l.local 2>/dev/null | head -1 | grep -o '([^)]*)'| tr -d '()')
      echo "l.local: $MDNS_IP"
    else
      echo "l.local: not resolving"
    fi
    echo ""
    echo "=== Docker Contexts (* = active) ==="
    docker context ls
    CONTEXT_NAME="colima-$PROFILE"
    if ! docker context ls --format '{{.Name}}' | grep -q "^${CONTEXT_NAME}$"; then
      echo ""
      echo "Context '$CONTEXT_NAME' does not exist."
    elif ! docker context ls --format '{{.Current}} {{.Name}}' | grep -q "^true ${CONTEXT_NAME}$"; then
      echo ""
      echo "To switch to this profile's context run:"
      echo "  docker context use $CONTEXT_NAME"
    fi
    echo ""
    echo "=== VM Network ==="
    if ssh "colima-$PROFILE" "wget -q --spider https://nixos.org" 2>/dev/null; then
      echo "DNS: ready"
    else
      echo "DNS: not ready"
    fi
    ;;
  rm)
    echo "=== REMOVING VM ==="
    read -p "Delete VM profile '$PROFILE'? This will destroy all data. [y/N] " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      colima delete --profile "$PROFILE" --force
    else
      echo "Aborted."
    fi
    ;;
  provision)
    echo "=== PROVISIONING VM ==="
    SSH_HOST="colima-$PROFILE"

    # System provisioning (as root)
    ssh "$SSH_HOST" "sudo bash -s" <<'SYSTEM_EOF'
      set -e
      [ -f /etc/provision-system-done ] && echo "System already provisioned" && exit 0

      echo "==> Installing Tailscale..."
      if ! command -v tailscale &> /dev/null; then
        wget -qO- https://tailscale.com/install.sh | sh
      fi

      echo "==> Installing Nix dependencies..."
      apt-get update && apt-get install -y xz-utils

      echo "==> Installing Nix..."
      if [ ! -d /nix ]; then
        wget -O /tmp/nix-install.sh https://nixos.org/nix/install
        sh /tmp/nix-install.sh --daemon --yes
        rm /tmp/nix-install.sh
      fi

      echo "==> Enabling Nix experimental features..."
      if ! grep -q "experimental-features" /etc/nix/nix.conf 2>/dev/null; then
        echo "experimental-features = fetch-tree nix-command flakes" >> /etc/nix/nix.conf
        systemctl restart nix-daemon
      fi

      echo "==> Installing and configuring Avahi (mDNS)..."
      apt-get install -y avahi-daemon
      cat > /etc/avahi/avahi-daemon.conf <<'AVAHI_CONF'
[server]
host-name=l
domain-name=local
use-ipv4=yes
use-ipv6=yes
allow-interfaces=eth0

[publish]
publish-addresses=yes
publish-hinfo=no
publish-workstation=no

[reflector]

[rlimits]
AVAHI_CONF
      systemctl enable avahi-daemon
      systemctl restart avahi-daemon

      touch /etc/provision-system-done
      echo "==> System provisioning complete"
SYSTEM_EOF

    # User provisioning
    ssh "$SSH_HOST" "bash -s" <<'USER_EOF'
      set -e
      [ -f ~/.provision-user-done ] && echo "User already provisioned" && exit 0

      echo "==> Sourcing Nix..."
      if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi

      echo "==> Setting up home-manager config..."
      if [ ! -d ~/.config/home-manager ]; then
        mkdir -p ~/.config
        git clone https://github.com/safareli/l.git ~/.config/home-manager
      fi

      echo "==> Running home-manager switch..."
      nix run home-manager/master -- switch -b bak --flake ~/.config/home-manager

      echo "==> Setting zsh as default shell..."
      sudo chsh -s "$(which zsh)" "$USER"

      echo "==> Enabling linger for user services..."
      sudo loginctl enable-linger "$USER"

      touch ~/.provision-user-done
      echo "==> User provisioning complete"
USER_EOF
    "$0" down
    "$0" up
    "$0" health
    ;;
  *)
    echo "Usage: vm [setup|config|up|down|health|rm|provision|ssh]"
    exit 1
    ;;
esac
